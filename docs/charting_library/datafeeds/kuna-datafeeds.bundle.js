!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.KunaTW={})}(this,function(e){"use strict";var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function r(n,i,a,u){return new(a=a||Promise)(function(e,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function s(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,s)}o((u=u.apply(n,i||[])).next())})}function l(r,s){var o,n,i,e,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,n&&(i=n[2&t[0]?"return":t[0]?"throw":"next"])&&!(i=i.call(n,t[1])).done)return i;switch(n=0,i&&(t=[0,i.value]),t[0]){case 0:case 1:i=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,n=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(i=0<(i=a.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){a.label=t[1];break}if(6===t[0]&&a.label<i[1]){a.label=i[1],i=t;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(t);break}i[2]&&a.ops.pop(),a.trys.pop();continue}t=s.call(r,a)}catch(e){t=[6,e],n=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var s=!1;function u(e){if(s){var t=new Date;console.log(t.toLocaleTimeString()+"."+t.getMilliseconds()+"> "+e)}}function c(e){return void 0===e?"":"string"==typeof e?e:e.message}var n=(o.prototype.getBars=function(e,t,r,s){var o=this,n={symbol:e.ticker||"",resolution:t,from:r,to:s};return new Promise(function(a,u){o._requester.sendRequest(o._datafeedUrl,"history",n).then(function(e){if("ok"===e.s||"no_data"===e.s){var t=[],r={noData:!1};if("no_data"===e.s)r.noData=!0,r.nextTime=e.nextTime;else for(var s=void 0!==e.v,o=void 0!==e.o,n=0;n<e.t.length;++n){var i={time:1e3*e.t[n],close:Number(e.c[n]),open:Number(e.c[n]),high:Number(e.c[n]),low:Number(e.c[n])};o&&(i.open=Number(e.o[n]),i.high=Number(e.h[n]),i.low=Number(e.l[n])),s&&(i.volume=Number(e.v[n])),t.push(i)}a({bars:t,meta:r})}else u(e.errmsg)}).catch(function(e){var t=c(e);console.warn("HistoryProvider: getBars() failed, error="+t),u(t)})})},o);function o(e,t){this._datafeedUrl=e,this._requester=t}var i=(a.prototype.subscribeBars=function(e,t,r,s){this._subscribers.hasOwnProperty(s)?u("DataPulseProvider: already has subscriber with id="+s):(this._subscribers[s]={lastBarTime:null,listener:r,resolution:t,symbolInfo:e},u("DataPulseProvider: subscribed for #"+s+" - {"+e.name+", "+t+"}"))},a.prototype.unsubscribeBars=function(e){delete this._subscribers[e],u("DataPulseProvider: unsubscribed for #"+e)},a.prototype._updateData=function(){var r=this;if(!(0<this._requestsPending)){this._requestsPending=0;var e=function(t){s._requestsPending+=1,s._updateDataForSubscriber(t).then(function(){r._requestsPending-=1,u("DataPulseProvider: data for #"+t+" updated successfully, pending="+r._requestsPending)}).catch(function(e){r._requestsPending-=1,u("DataPulseProvider: data for #"+t+" updated with error="+c(e)+", pending="+r._requestsPending)})},s=this;for(var t in this._subscribers)e(t)}},a.prototype._updateDataForSubscriber=function(t){var r=this,e=this._subscribers[t],s=parseInt((Date.now()/1e3).toString()),o=s-function(e,t){return 24*("D"===e||"1D"===e?t:"M"===e||"1M"===e?31*t:"W"===e||"1W"===e?7*t:t*parseInt(e)/1440)*60*60}(e.resolution,10);return this._historyProvider.getBars(e.symbolInfo,e.resolution,o,s).then(function(e){r._onSubscriberDataReceived(t,e)})},a.prototype._onSubscriberDataReceived=function(e,t){if(this._subscribers.hasOwnProperty(e)){var r=t.bars;if(0!==r.length){var s=r[r.length-1],o=this._subscribers[e];if(!(null!==o.lastBarTime&&s.time<o.lastBarTime)){if(null!==o.lastBarTime&&s.time>o.lastBarTime){if(r.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");var n=r[r.length-2];o.listener(n)}o.lastBarTime=s.time,o.listener(s)}}}else u("DataPulseProvider: Data comes for already unsubscribed subscription #"+e)},a);function a(e,t){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),t)}var h=(f.prototype.subscribeQuotes=function(e,t,r,s){this._subscribers[s]={symbols:e,fastSymbols:t,listener:r},u("QuotesPulseProvider: subscribed quotes with #"+s)},f.prototype.unsubscribeQuotes=function(e){delete this._subscribers[e],u("QuotesPulseProvider: unsubscribed quotes with #"+e)},f.prototype._updateQuotes=function(s){var o=this;if(!(0<this._requestsPending)){var e=function(t){n._requestsPending++;var r=n._subscribers[t];n._quotesProvider.getQuotes(1===s?r.fastSymbols:r.symbols).then(function(e){o._requestsPending--,o._subscribers.hasOwnProperty(t)&&(r.listener(e),u("QuotesPulseProvider: data for #"+t+" ("+s+") updated successfully, pending="+o._requestsPending))}).catch(function(e){o._requestsPending--,u("QuotesPulseProvider: data for #"+t+" ("+s+") updated with error="+c(e)+", pending="+o._requestsPending)})},n=this;for(var t in this._subscribers)e(t)}},f);function f(e){this._subscribers={},this._requestsPending=0,this._quotesProvider=e,setInterval(this._updateQuotes.bind(this,1),1e4),setInterval(this._updateQuotes.bind(this,0),6e4)}function d(e,t,r,s){var o=e[t];return!Array.isArray(o)||s&&!Array.isArray(o[0])?o:o[r]}var p=(b.prototype.resolveSymbol=function(t){var r=this;return this._readyPromise.then(function(){var e=r._symbolsInfo[t];return void 0===e?Promise.reject("invalid symbol"):Promise.resolve(e)})},b.prototype.searchSymbols=function(a,u,c,o){var l=this;return this._readyPromise.then(function(){var n=[],i=0===a.length;a=a.toUpperCase();for(var e=function(e){var t=l._symbolsInfo[e];if(void 0===t)return"continue";if(0<c.length&&t.type!==c)return"continue";if(u&&0<u.length&&t.exchange!==u)return"continue";var r=t.name.toUpperCase().indexOf(a),s=t.description.toUpperCase().indexOf(a);if((i||0<=r||0<=s)&&!n.some(function(e){return e.symbolInfo===t})){var o=0<=r?r:8e3+s;n.push({symbolInfo:t,weight:o})}},t=0,r=l._symbolsList;t<r.length;t++)e(r[t]);var s=n.sort(function(e,t){return e.weight-t.weight}).slice(0,o).map(function(e){var t=e.symbolInfo;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}});return Promise.resolve(s)})},b.prototype._init=function(){for(var e=this,t=[],r={},s=0,o=this._exchangesList;s<o.length;s++){var n=o[s];r[n]||(r[n]=!0,t.push(this._requestExchangeData(n)))}return Promise.all(t).then(function(){e._symbolsList.sort(),u("SymbolsStorage: All exchanges data loaded")})},b.prototype._requestExchangeData=function(s){var o=this;return new Promise(function(t,r){o._requester.sendRequest(o._datafeedUrl,"symbol_info",{group:s}).then(function(e){try{o._onExchangeDataReceived(s,e)}catch(e){return void r(e)}t()}).catch(function(e){u("SymbolsStorage: Request data for exchange '"+s+"' failed, reason="+c(e)),t()})})},b.prototype._onExchangeDataReceived=function(t,r){var e=this,s=0;try{for(var o=r.symbol.length,n=void 0!==r.ticker;s<o;++s){var i=r.symbol[s],a=d(r,"exchange-listed",s),u=d(r,"exchange-traded",s),c=u+":"+i,l=n?d(r,"ticker",s):i,h={ticker:l,name:i,base_name:[a+":"+i],full_name:c,listed_exchange:a,exchange:u,description:d(r,"description",s),has_intraday:m(d(r,"has-intraday",s),!1),has_no_volume:m(d(r,"has-no-volume",s),!1),minmov:d(r,"minmovement",s)||d(r,"minmov",s)||0,minmove2:d(r,"minmove2",s)||d(r,"minmov2",s),fractional:d(r,"fractional",s),pricescale:d(r,"pricescale",s),type:d(r,"type",s),session:d(r,"session-regular",s),timezone:d(r,"timezone",s),supported_resolutions:m(d(r,"supported-resolutions",s,!0),e._datafeedSupportedResolutions),force_session_rebuild:d(r,"force-session-rebuild",s),has_daily:m(d(r,"has-daily",s),!0),intraday_multipliers:m(d(r,"intraday-multipliers",s,!0),["1","5","15","30","60"]),has_weekly_and_monthly:d(r,"has-weekly-and-monthly",s),has_empty_bars:d(r,"has-empty-bars",s),volume_precision:m(d(r,"volume-precision",s),0)};e._symbolsInfo[l]=h,e._symbolsInfo[i]=h,e._symbolsInfo[c]=h,e._symbolsList.push(i)}}catch(e){throw new Error("SymbolsStorage: API error when processing exchange "+t+" symbol #"+s+" ("+r.symbol[s]+"): "+e.message)}},b);function b(e,t,r){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=r,this._readyPromise=this._init(),this._readyPromise.catch(function(e){console.error("SymbolsStorage: Cannot init, error="+e.toString())})}function m(e,t){return void 0!==e?e:t}function _(e,t,r){var s=e[t];return Array.isArray(s)?s[r]:s}var y=(v.prototype.onReady=function(e){var t=this;this._configurationReadyPromise.then(function(){e(t._configuration)})},v.prototype.getQuotes=function(s,o,n){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this._quotesProvider.getQuotes(s)];case 1:return t=e.sent(),o(t),[3,3];case 2:return r=e.sent(),n(r),[3,3];case 3:return[2]}})})},v.prototype.subscribeQuotes=function(e,t,r,s){this._quotesPulseProvider.subscribeQuotes(e,t,r,s)},v.prototype.unsubscribeQuotes=function(e){this._quotesPulseProvider.unsubscribeQuotes(e)},v.prototype.calculateHistoryDepth=function(e,t,r){},v.prototype.getMarks=function(e,t,r,s,o){if(this._configuration.supports_marks){var n={symbol:e.ticker||"",from:t,to:r,resolution:o};this._send("marks",n).then(function(e){if(!Array.isArray(e)){for(var t=[],r=0;r<e.id.length;++r)t.push({id:_(e,"id",r),time:_(e,"time",r),color:_(e,"color",r),text:_(e,"text",r),label:_(e,"label",r),labelFontColor:_(e,"labelFontColor",r),minSize:_(e,"minSize",r)});e=t}s(e)}).catch(function(e){u("UDFKunaDatafeed: Request marks failed: "+c(e)),s([])})}},v.prototype.getTimescaleMarks=function(e,t,r,s,o){if(this._configuration.supports_timescale_marks){var n={symbol:e.ticker||"",from:t,to:r,resolution:o};this._send("timescale_marks",n).then(function(e){if(!Array.isArray(e)){for(var t=[],r=0;r<e.id.length;++r)t.push({id:_(e,"id",r),time:_(e,"time",r),color:_(e,"color",r),label:_(e,"label",r),tooltip:_(e,"tooltip",r)});e=t}s(e)}).catch(function(e){u("UDFKunaDatafeed: Request timescale marks failed: "+c(e)),s([])})}},v.prototype.getServerTime=function(r){this._configuration.supports_time&&this._send("time").then(function(e){var t=parseInt(e);isNaN(t)||r(t)}).catch(function(e){u("UDFKunaDatafeed: Fail to load server time, error="+c(e))})},v.prototype.searchSymbols=function(t,e,r,s){if(this._configuration.supports_search){var o={limit:30,query:t.toUpperCase(),type:r,exchange:e};this._send("search",o).then(function(e){if(void 0!==e.s)return u("UDFKunaDatafeed: search symbols error="+e.errmsg),void s([]);s(e)}).catch(function(e){u("UDFKunaDatafeed: Search symbols for '"+t+"' failed. Error="+c(e)),s([])})}else{if(null===this._symbolsStorage)throw new Error("UDFKunaDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(t,e,r,30).then(s).catch(s.bind(null,[]))}},v.prototype.resolveSymbol=function(n,i,a){return r(this,void 0,void 0,function(){function t(e){u("Symbol resolved: "+(Date.now()-r)+"ms"),e.exchange="",e.listed_exchange="",e.full_name="",e.ticker=e.name,i(e)}var r,s,o;return l(this,function(e){switch(e.label){case 0:if(u("Resolve requested"),r=Date.now(),this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UDFKunaDatafeed: inconsistent configuration (symbols storage)");return this._symbolsStorage.resolveSymbol(n).then(t).catch(a),[2]}s={symbol:n},u("Try resolve "+n),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this._send("symbols",s)];case 2:return void 0!==(o=e.sent()).s?a("unknown_symbol"):t(o),[3,4];case 3:return u("UDFKunaDatafeed: Error resolving symbol: "+c(e.sent())),a("unknown_symbol"),[3,4];case 4:return[2]}})})},v.prototype.getBars=function(o,n,i,a,u,c){return r(this,void 0,void 0,function(){var t,r,s;return l(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this._historyProvider.getBars(o,n,i,a)];case 1:return t=e.sent(),r=t.bars[t.bars.length-1],(!this.lastBar||this.lastBar.time<r.time||this.lastResolution!==n)&&(this.lastBar=r,this.lastResolution=n),u(t.bars,t.meta),[3,3];case 2:return s=e.sent(),c(s),[3,3];case 3:return[2]}})})},v.prototype.subscribeBars=function(e,t,r,s,o){this._dataPulseProvider.subscribeBars(e,t,r,s)},v.prototype.unsubscribeBars=function(e){this._dataPulseProvider.unsubscribeBars(e)},v.prototype._requestConfiguration=function(){return r(this,void 0,void 0,function(){return l(this,function(e){try{return[2,this._send("config")]}catch(e){return u("UDFKunaDatafeed: Cannot get datafeed configuration - use default, error="+c(e)),[2,null]}return[2]})})},v.prototype._send=function(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)},v.prototype._setupWithConfiguration=function(e){if(void 0===(this._configuration=e).exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new p(this._datafeedURL,e.supported_resolutions||[],this._requester)),u("UDFKunaDatafeed: Initialized with "+JSON.stringify(e))},v);function v(e,t,r,s){void 0===s&&(s=1e4);var o=this;this._configuration={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1},this._symbolsStorage=null,this._datafeedURL=e,this._requester=r,this._historyProvider=new n(e,this._requester),this._quotesProvider=t,this._dataPulseProvider=new i(this._historyProvider,s),this._quotesPulseProvider=new h(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(function(e){null===e&&(e={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}),o._setupWithConfiguration(e)})}var g=(P.prototype.getQuotes=function(e){var s=this;return new Promise(function(t,r){s._requester.sendRequest(s._datafeedUrl,"quotes",{symbols:e}).then(function(e){"ok"===e.s?t(e.d):r(e.errmsg)}).catch(function(e){var t=c(e);u("QuotesProvider: getQuotes failed, error="+t),r("network error: "+t)})})},P);function P(e,t){this._datafeedUrl=e,this._requester=t}var w=(q.prototype.sendRequest=function(e,t,r){if(void 0!==r){var s=Object.keys(r);0!==s.length&&(t+="?"),t+=s.map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e].toString())}).join("&")}u("New request: "+t);var o={credentials:"same-origin"};return void 0!==this._headers&&(o.headers=this._headers),fetch(e+"/"+t,o).then(function(e){return e.text()}).then(function(e){return JSON.parse(e)})},q);function q(e){e&&(this._headers=e)}var D,S,x,k=(t(D=R,S=x=y),void(D.prototype=null===S?Object.create(S):(B.prototype=S.prototype,new B)),R.prototype.searchSymbols=function(e,t,r,s){u("Not works yet.")},R.prototype.resolvePusher=function(){"pusher"in window&&(this.pusher=window.pusher)},R.prototype.getChannel=function(e){if(!this.pusher)throw new Error("Pusher have not initialized");var t=this.pusher.channel(e);return t=t||this.pusher.subscribe(e)},R.prototype.subscribeBars=function(e,t,r,s,o){if(this.pusher){var n=["market",e.name,"global"].join("-");this.getChannel(n).bind("trades",this.handlerTrade.bind(this)),this.subscriptions[s]={symbolInfo:e,resolution:t,lastBarTime:void 0,listener:r,channel:n,event:"trades"}}else this._dataPulseProvider.subscribeBars(e,t,r,s)},R.prototype.unsubscribeBars=function(e){var t=this.subscriptions[e];t&&(this.getChannel(t.channel).unbind(t.event,this.handlerTrade.bind(this)),delete this.subscriptions[e])},R.prototype.handlerTrade=function(e){var t=this;for(var r in t.subscriptions)if(t.subscriptions.hasOwnProperty(r)){var s=t.subscriptions[r],o=U(s.resolution,1),n=Math.floor((new Date).getTime()/o)*o,i=e.trades[0];if(i){var a=void 0,u=parseFloat(i.price),c=parseFloat(i.amount);a=!t.lastBar||t.lastBar.time<n?{time:n,volume:c,open:u,close:u,high:u,low:u}:{time:n,volume:(t.lastBar.volume||0)+c,close:u,open:t.lastBar.open,high:t.lastBar.high>u?t.lastBar.high:u,low:t.lastBar.low<u?t.lastBar.low:u},t.lastBar=a,s.listener(a)}}},R);function B(){this.constructor=D}function R(e,t){void 0===t&&(t=1e4);var r=this,s=new w,o=new g(e,s);return(r=x.call(this,e,o,s,t)||this).subscriptions={},r.resolvePusher(),r}function U(e,t){return 24*("D"===e||"1D"===e?t:"M"===e||"1M"===e?31*t:"W"===e||"1W"===e?7*t:t*parseInt(e)/1440)*60*60*1e3}e.KunaDatafeeds=k,Object.defineProperty(e,"__esModule",{value:!0})});
